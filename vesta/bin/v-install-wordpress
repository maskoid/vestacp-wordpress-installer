#!/bin/bash
# info: install wordpress
# options: domain install_path admin_email admin_user blog_title fname lname dbname dbuser dbpassword
#
# The function will install latest wordpress blog.
# Developed by maskoid.com vist us @ https://github.com/maskoid



#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument definition
user=$1
domain=$2
path=$3
admin_user=$4
admin_passwd=$5
admin_email=$6
blog_title=$7
fname=$8
lname=$9
https=${10}
www=${11}

WORKINGDIR="/home/$user/web/$domain/public_html$path"
wp="/usr/local/vesta/bin/wp-cli.phar"

#Sample
# v-install-wordpress admin maskoid.com / adminxwp adminwppasswd contact@maskoid.com "Maskoid Techno" "Mohammad Azad" "Shaikh" wpdbdata wpdbuser dbpasswd yes no
# 

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#


if [ ! -d "/home/$user" ]; then
    echo -e "${RED}User doesn't exist${NC}";
    exit 1;
fi

if [ ! -d "/home/$user/web/$domain/public_html" ]; then
    echo -e "${RED}Domain doesn't exist${NC}";
    exit 1;
fi

# Check if Install Folder is Empty
if [ "$(ls -A $WORKINGDIR)" ]; then
    #install dir is not empty
    FILECOUNT=$(find $WORKINGDIR -type f | wc -l)
    DIRCOUNT=$(find $WORKINGDIR -type d | wc -l)
    if [ $FILECOUNT == "2" ] && [ $DIRCOUNT == "1" ]; then
    	rm -rf $WORKINGDIR/*
    else
    	echo -e "${RED} $WORKINGDIR is not empty ${NC}";
        exit 1;
 	fi
fi

# Check if WP-CLI is Installed

if [ ! -f $wp ]; then
    echo -e "${RED}WP-CLI not found. First Install WP-CLI${NC}";
    exit 1;
fi



#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

### Create Database ###
#Generating Database Name and User (both will be same)
i=0;
while [ $i -lt 1000 ]
do
i=$((i+1));
dbname=$(cat /dev/urandom | tr -dc 'a-zA-Z' | fold -w 6 | head -n 1)
dbuser=$user\_$dbname;
if [ ! -d "/var/lib/mysql/$dbuser" ]; then
break;
fi
done

#Generating Database Password
dbpassword=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 12 | head -n 1)

dbinstallresult=$(/usr/bin/sudo /usr/local/vesta/bin/v-add-database $user $dbname $dbname $dbpassword)

if [ -z "$dbinstallresult" ]
then
      echo "Database Created Successfully"
else
      echo "$dbinstallresult"
      exit 1;
fi
## So that both will have admin_ in dbname dbuser
dbname=$dbuser

### Install Wordpress ###

cd $WORKINGDIR


echo -e "${YELLOW}###################################################################"
echo -e "We are installing Wordpress ...."
echo -e "###################################################################"
echo -e "\n
# Must Required
$user
$domain
$path
# Optional
$admin_user
$admin_passwd
$admin_email
$blog_title
$fname
$lname
$dbname
$dbuser
$dbpassword
$https
$www
${NC}
"


sudo -H -u $user $wp core download

sudo -H -u $user $wp config create --dbname=$dbname --dbuser=$dbuser --dbpass=$dbpassword --dbhost='localhost' --dbprefix='wp_'

sudo -H -u $user $wp core install --url="$domain" --title="$blog_title" --admin_user="$admin_user" --admin_password="$admin_passwd" --admin_email="$admin_email"

sudo -H -u $user $wp user update "$admin_user" --first_name="$fname" --last_name="$lname" --display_name="Admin"


### Setup .htaccess and robots.txt file ###

curl -O https://raw.githubusercontent.com/maskoid/vestacp-wordpress-installer/master/resources/robots.txt
curl -O https://raw.githubusercontent.com/maskoid/vestacp-wordpress-installer/master/resources/.htaccess

sudo rm -f readme.html

#----------------------------------------------------------#
#                       Vesta                              #
#----------------------------------------------------------#


#will use this when installed in nginx